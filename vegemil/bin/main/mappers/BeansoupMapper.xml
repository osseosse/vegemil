<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vegemil.mapper.BeansoupMapper">
	
	<!-- ///////////////// [m_beansoup] ///////////////// -->
	
	<sql id="beansoupColumns">
		idx, 
		file_no, 
		css_class, 
		l_cate, 
		m_cate, 
		product, 
		name, 
		title, 
		tag, 
		ingredient, 
		cooking, 
		tip, 
		display,
		keyword
	</sql>

	<select id="selectBeansoupList" parameterType="String" resultType="com.vegemil.domain.BeansoupDTO">
		SELECT
			<include refid="beansoupColumns" />
		FROM
			m_beansoup
		WHERE
			display = '1'
		ORDER BY
			idx DESC
	</select>
	
	<select id="selectBeanListWithKeyword" parameterType="String" resultType="com.vegemil.domain.BeansoupDTO">
		SELECT
			<include refid="beansoupColumns" />
		FROM
			m_beansoup
		WHERE
			display = '1'
		<if test="searchKeyword != null and searchKeyword != ''">  
		  	AND l_cate like CONCAT('%',#{searchKeyword},'%')
		  	OR m_cate like CONCAT('%',#{searchKeyword},'%')
		  	OR product like CONCAT('%',#{searchKeyword},'%')
		  	OR name like CONCAT('%',#{searchKeyword},'%')
		  	OR title like CONCAT('%',#{searchKeyword},'%')
		  	OR tag like CONCAT('%',#{searchKeyword},'%')
		  	OR ingredient like CONCAT('%',#{searchKeyword},'%')
		  	OR cooking like CONCAT('%',#{searchKeyword},'%')
		  	OR tip like CONCAT('%',#{searchKeyword},'%')
		  	OR display like CONCAT('%',#{searchKeyword},'%')
		  	OR keyword like CONCAT('%',#{searchKeyword},'%')
		  	OR n_cate like CONCAT('%',#{searchKeyword},'%')
		</if>  
		ORDER BY
			idx DESC
	</select>
	
	<select id="selectBeanListWithKeywordRenew" parameterType="String" resultType="com.vegemil.domain.BeansoupDTO">
		SELECT
			/* selectBeanListWithKeywordRenew */
			<include refid="beansoupColumns" />
		FROM
			m_beansoup
		WHERE
			<!-- display = '1' 잠깐 주석 -->
		<if test="searchKeyword != null and searchKeyword != ''">  
		 	n_cate like CONCAT('%',#{searchKeyword},'%')
		 OR product like CONCAT('%',#{searchKeyword},'%')

		</if>  
		ORDER BY
			idx DESC
	</select>

	<select id="selectBeansoupListCount" parameterType="com.vegemil.domain.BeansoupDTO" resultType="int">
		SELECT
			COUNT(*)
		FROM
			m_beansoup
		WHERE
			display = '1'
	</select>
	
	<select id="selectBeansoupProposalList" parameterType="String" resultType="com.vegemil.domain.BeansoupDTO">
		SELECT
			<include refid="beansoupColumns" />
		FROM
			m_beansoup
		WHERE
			display = '1'
		
		<if test="nCate != null and nCate != ''">
			AND n_cate like CONCAT('%',#{nCate},'%')
		</if>
		ORDER BY RAND()
		LIMIT 4;
	</select>
	
	<select id="selectBeansoupDetail" parameterType="String" resultType="com.vegemil.domain.BeansoupDTO">
		SELECT
			<include refid="beansoupColumns" />
		FROM
			m_beansoup
		WHERE
			file_no = #{fileNo}
	</select>
	
	<!-- ///////////////// [m_beansoup_event] ///////////////// -->
	
	<sql id="beansoupEventColumns">
		m_idx, 
		m_title, 
		m_startDate,
		m_endDate, 
		m_ing, 
		m_display, 
		m_thum, 
		m_img, 
		m_eday_id,
		m_content, 
		m_type, 
		m_product
	</sql>
                   
	<select id="selectBeansoupEventList" parameterType="com.vegemil.domain.BeansoupEventDTO" resultType="com.vegemil.domain.BeansoupEventDTO">
		SELECT
			<include refid="beansoupEventColumns" />
		FROM
			m_beansoup_event
		WHERE
			m_display = '1'
		ORDER BY
			m_idx DESC
		LIMIT
			#{paginationInfo.firstRecordIndex}, #{paginationInfo.lastRecordIndex}
	</select>
	
	<select id="selectMainBeansoupEventList" resultType="com.vegemil.domain.BeansoupEventDTO">
		SELECT
			<include refid="beansoupEventColumns" />
		FROM
			m_beansoup_event
		WHERE
			m_ing = '1'
		ORDER BY
			m_idx DESC
		<!-- LIMIT
			#{paginationInfo.firstRecordIndex}, #{paginationInfo.lastRecordIndex} -->
	</select>

	<select id="selectBeansoupEventCount" parameterType="com.vegemil.domain.BeansoupEventDTO" resultType="int">
		SELECT
			COUNT(*)
		FROM
			m_beansoup_event
		WHERE
			m_display = '1'
	</select>
	
	<!-- ///////////////// [m_beansoup_news] ///////////////// -->
	
	<sql id="beansoupNewsColumns">
		m_idx,
		m_title, 
		m_url, 
		m_thum, 
		m_display, 
		m_writeDate, 
		m_start_date, 
		m_end_date, 
		m_ing
	</sql>
	
	<select id="selectBeansoupNewsList" parameterType="String" resultType="com.vegemil.domain.BeansoupNewsDTO">
		SELECT
			<include refid="beansoupNewsColumns" />
		FROM
			m_beansoup_news
		WHERE
			m_display = '1'
		
		ORDER BY
			m_idx DESC
	</select>

	<select id="selectBeansoupNewsListCount" parameterType="com.vegemil.domain.BeansoupNewsDTO" resultType="int">
		SELECT
			COUNT(*)
		FROM
			m_beansoup_news
		WHERE
			m_display = '1'
	</select>
	
	<!-- ///////////////// [m_beansoup_video] ///////////////// -->
	
	<sql id="beansoupVideoColumns">
		m_idx,
		m_title, 
		m_display, 
		m_writeDate, 
		m_src
	</sql>

	<select id="selectBeansoupVideoList" parameterType="com.vegemil.domain.BeansoupVideoDTO" resultType="com.vegemil.domain.BeansoupVideoDTO">
		SELECT
			<include refid="beansoupVideoColumns" />
		FROM
			m_beansoup_video
		WHERE
			m_display = '1'
		ORDER BY
			m_idx DESC
		LIMIT
			#{paginationInfo.firstRecordIndex}, #{paginationInfo.lastRecordIndex}
	</select>
	
	<select id="selectBeansoupVideoCount" parameterType="com.vegemil.domain.BeansoupVideoDTO" resultType="int">
		SELECT
			COUNT(*)
		FROM
			m_beansoup_video
		WHERE
			m_display = '1'
	</select>
	
	
	<!-- <select id="selectBeanSoupEventList" parameterType="hashMap" resultType="com.vegemil.domain.AdminBeanSoupEventDTO">
		SELECT
			m_idx
		    , m_startDate
			, m_ing
			, m_display
			, m_thum
			, m_thum_original
			, m_eday_id
			, m_content		
			, m_type
			, m_product
		FROM
			m_beansoup_event
		WHERE 1=1
			m_display = 1
		ORDER BY
			m_idx DESC
			
	</select> -->
	
	<!-- ///////////////// [m_beansoup_painting_contest] 2308 그림 동시 대회 ///////////////// -->
	<sql id="PaintingContestColumns">
		id, 
		section, 
		material, 
		painting_filename, 
		painting_saved_filename, 
		painting_desc, 
		guardian_name, 
		guardian_ph, 
		guardian_addr, 
		contestant_name, 
		contestant_birth, 
		contestant_grade, 
		contest_root, 
		beansoup_awareness,
		insert_date,
		update_date
	</sql>
	<sql id="PaintingContestAwardColumns">
		id,
		section,
		award,
		material,
		guardian_name, 
		guardian_ph, 
		contestant_name, 
		contestant_grade, 
		painting_desc, 
		painting_filename
	</sql>
	
	<!-- 그림 동시 대회 지원 -->
	<insert id="insertPaintingContest" parameterType="com.vegemil.domain.contest.PaintingContestDTO">
		/* insertPaintingContest by BeansoupMapper.xml */
		INSERT INTO m_beansoup_painting_contest (
			section, 
			material, 
			painting_filename, 
			painting_saved_filename, 
			painting_desc, 
			guardian_name, 
			guardian_ph, 
			guardian_di,			
			contestant_name, 
			contestant_birth, 
			contestant_grade, 
			contest_root, 
			beansoup_awareness,
			marketing_agree,
			zip_code,
			addr1,
			addr2,
			insert_time,
			update_time
		) VALUES (
			  #{section}
			, #{material}
			, #{paintingFilename}
			, #{paintingSavedFilename}
			, #{paintingDesc}
			, #{guardianName}
			, #{guardianPh}
			, #{guardianDI}			
			, #{contestantName}
			, #{contestantBirth}
			, #{contestantGrade}
			, #{contestRoot}
			, #{beansoupAwareness}
			, #{marketingAgree}
			, #{zipCode}
			, #{addr1}
			, #{addr2}
			, NOW()
			, NOW()
		)
	</insert>
	
	<!-- 동시 그림 참가자 리스트 조회 -->
	<select id="selectPaintingContestList" parameterType="com.vegemil.domain.contest.PaintingContestDTO" 
													resultType="com.vegemil.domain.contest.PaintingContestDTO">
		SELECT * 
		FROM m_beansoup_painting_contest
		WHERE 1=1 
		<!-- 부문 검색 들어왔을때 -->
		<if test="section != null and section != ''">
			AND section LIKE CONCAT('%', #{section} ,'%')
		</if>
		<!-- 주제 키워드 검색 들어왔을때 -->
		<if test="material != null and material != ''">
			AND material LIKE CONCAT('%', #{material} ,'%')
		</if>
		<!-- 검색 키워드가 있을 때 -->
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <!-- 검색 유형이 있을 때 -->
                <when test="searchType != null and searchType != ''">
                    <choose>
                        <when test="'guardianName'.equals( searchType )"> <!-- 보호자 이름 -->
                            AND guardian_name LIKE CONCAT('%', #{searchKeyword}, '%')
                        </when>
                        <when test="'contestantName'.equals( searchType )"> <!-- 참가자 이름 -->
                            AND contestant_name LIKE CONCAT('%', #{searchKeyword}, '%')
                        </when>
                        <when test="'section'.equals( searchType )"> <!-- 부문(나이) -->
                            AND section LIKE CONCAT('%', #{searchKeyword}, '%')
                        </when>
                        <when test="'material'.equals( searchType )"> <!-- 선택 시제 -->
                            AND material LIKE CONCAT('%', #{searchKeyword}, '%')
                        </when>
                    </choose>
                </when>
                <!-- 전체 검색일 때 때 -->
                <otherwise>
                    AND (
                        section LIKE CONCAT('%', #{searchKeyword}, '%')
                        OR material LIKE CONCAT('%', #{searchKeyword}, '%')
                        OR contestant_name LIKE CONCAT('%', #{searchKeyword}, '%')
                        OR guardian_name LIKE CONCAT('%', #{searchKeyword}, '%')
                        OR painting_desc LIKE CONCAT('%', #{searchKeyword}, '%')
                    )
                </otherwise>
            </choose>
        </if>
        ORDER BY ID DESC		
        LIMIT #{start, jdbcType=INTEGER}, #{length, jdbcType=INTEGER}
	</select>
	
	<!-- 동시 그림 순위 선정 -->
	<update id="updatePaintingContestPrize" parameterType="com.vegemil.domain.contest.PaintingContestDTO">
		UPDATE 
			m_beansoup_painting_contest
		SET
			prize = #{prize},
			update_time = NOW()
		WHERE 
			id = #{id} 	
	</update>
	
	<select id="selectCountConData" resultType="map">
		SELECT 	COUNT(CASE WHEN section='유치부문' THEN 1 END) as a,
				COUNT(CASE WHEN section='저학년' THEN 1 END) as b,
				COUNT(CASE WHEN section='고학년' THEN 1 END) as c 
		FROM m_beansoup_painting_contest;
	</select>
	
	<!-- // 수상자 전시 조회 우수상과 참가상  -->
	
	<select id="selectContestAwawrdList23" resultType="com.vegemil.domain.contest.PaintingContestAward23DTO"
																							parameterType="string">
										
		SELECT 
			<include refid="PaintingContestAwardColumns"/>
		FROM 
			m_contest_2023_award
		<if test="section != null and section != ''">
		WHERE 			
				section = #{section}
		</if> 
		ORDER BY display_order, contestant_name																					
	</select>
	
	<select id="selectContestAwardPaging23" parameterType="com.vegemil.domain.contest.PaintingContestAward23DTO" 
													resultType="com.vegemil.domain.contest.PaintingContestAward23DTO">
		SELECT 
			<include refid="PaintingContestAwardColumns"/>
		FROM m_contest_2023_award
		WHERE 1=1 
		<!-- 부문 검색 들어왔을때 -->
		<if test="section != null and section != ''">
			AND section LIKE CONCAT('%', #{section} ,'%')
		</if>
		<!-- 주제 키워드 검색 들어왔을때 -->
		<if test="searchKeyword != null and searchKeyword != ''">
			AND contestant_name LIKE CONCAT('%', #{searchKeyword} ,'%')
		</if>
        ORDER BY display_order, contestant_name			 		
        LIMIT
			#{paginationInfo.firstRecordIndex}, 12
	</select>
	
	<select id="selectContestWinner"  parameterType="com.vegemil.domain.contest.PaintingContestAward23DTO" 
													resultType="com.vegemil.domain.contest.PaintingContestAward23DTO">
		SELECT 
			<include refid="PaintingContestAwardColumns"/> 
		FROM m_contest_2023_award		
		WHERE
			id = #{id}
	
	</select>
</mapper>